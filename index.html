<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Adam Eivy - Blue Origin</title>
    <link rel="stylesheet" type="text/css" href="build/build.css">
    <script src="https://use.fontawesome.com/aa75e2adb5.js"></script>
  </head>
  <body>
    <article id="presentation">
      <section>
        <div class="fullscreen"><img class="fill" src="images/wallpaper.jpg">
          <div class="credit">Updated: 2019-09-25</div>
        </div>
        <div class="multibox">
          <div class="box top left">
            <h2>Hello <span class="accent">Blue</span> Origin</h2>
            <div class="mid">from</div>
            <h2 class="notranslate">Adam Eivy <span class="rocking accent">\[._.]/</span>
              <div class="me center"></div>
            </h2>
          </div>
          <div class="box top right">
            <h2><a href="https://twitter.com/antic"><i class="fa fa-twitter-square"></i>&nbsp;@antic</a></h2>
            <h2><a href="https://adameivy.com"><i class="fa fa-external-link-square"></i>&nbsp;adameivy.com</a></h2>
            <h2><a href="https://bit.ly/adam_blue"><i class="fa fa-desktop"></i>&nbsp;bit.ly/adam_blue</a></h2>
            <h4>Talk Time: 50 minutes</h4>
            <h4><a href="https://www.youtube.com/watch?v=U9GlN8OuMkc&amp;t=2m30s" target="off">Carl Sagan</a></h4>
            <iframe width="280" height="157" src="https://www.youtube.com/embed/U9GlN8OuMkc?start=149" frameborder="0" allow="encrypted-media" allowfullscreen=""></iframe>
          </div>
        </div>
      </section>
      <section>
        <div class="fullscreen">
          <x-gif src="images/perfect_beardscratch.gif" fill></x-gif>
          <div class="credit">cinema gif thanks to:&nbsp;<a href="http://www.gideondevilliers.com" target="off">gideon de villiers</a></div>
        </div>
        <div class="multibox">
          <div class="box left bottom darker">
            <h2>Who am I?</h2>
            <ul>
              <li>Principal SWE, Disney</li>
              <li>17 years in Industry</li>
              <li>Full Stack (Data, UI, APIs, etc)</li>
              <li>Teaching</li>
              <li>DevSecOps</li>
              <li>Machine Learning</li>
              <li><span class="notify" title="Robert Heinlein">"Specialization is for Insects"</span></li>
            </ul>
          </div>
          <div class="box right">
            <div class="mid">obsessive</div>
          </div>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/photo-1524995997946-a1c2e315a42f.jpeg">
          <div class="credit">credit:&nbsp;<a href="https://unsplash.com/@syinq?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="off">Susan Yin</a></div>
        </div>
        <div class="box left black">
          <h2>Unusual Education</h2>
          <ul class="noprefix">
            <li>üìö Started Self-Taught</li>
            <li>üè´ Web Development, Seattle Central</li>
            <li>üöÄ <span class="em-blue">Force Multiplier</span></li>
            <li>üë®‚Äçüè´Ô∏è Teaching at Seattle Central</li>
            <li>üë®‚ÄçüíªÔ∏è Startups</li>
            <li>ü§≥ My Own Startup</li>
            <li>üè∞ Disney (8 years)</li>
          </ul>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img src="images/calendar-morning-closeup.jpg" style="position:absolute;z-index:999;height:100%"><img class="fill" src="images/erika-h-JmwJlcwkMgA-unsplash.jpg">
          <div class="credit">credit:&nbsp;<a href="https://unsplash.com/@erikahg?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="off">Erika H.</a></div>
        </div>
        <div class="box top right darker">
          <h2>Own Your Calendar</h2>
          <div class="mid">or it will own you</div>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/calendar-6-months.png"></div>
        <div class="box top darker">
          <h4>Only Six Months to Live?</h4>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/drawing.jpg"></div>
        <div class="box bottom">
          <div class="mid">daily creativity is vital</div>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/joanna-kosinska-1_CMoFsPfso-unsplash.jpg">
          <div class="credit left">credit:&nbsp;<a href="https://unsplash.com/@joannakosinska?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="off">Joanna Kosinska</a></div>
        </div>
        <div class="box right darker">
          <h2>10 Ideas Every Day</h2>
          <div class="mid">Benefits of Giving Up Alcohol</div>
          <ol class="tight">
            <li>always be ready for an emergency</li>
            <li>always be able to drive</li>
            <li>more drawing time</li>
            <li>more energy</li>
            <li><span class="em-green">longer, healthier life (+ 5-10 years)</span></li>
            <li>always be able to read to <span class="em-blue">my daughter</span></li>
            <li>more personal time</li>
            <li>play more music</li>
            <li>better sleep</li>
            <li>save money</li>
          </ol>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/yosh-ginsu-qexZLgMcbPc-unsplash.jpg">
          <div class="credit left">credit:&nbsp;<a href="https://unsplash.com/@yoshginsu?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="off">Yosh Ginsu</a></div>
        </div>
        <div class="box right darker">
          <h2>Emergency Prep</h2>
          <div class="mid">things to plan for...</div>
          <ul class="noprefix">
            <li>‚úÖ Earthquake</li>
            <li>‚úÖ Fire</li>
            <li>‚úÖ Mt Rainier Eruption</li>
            <li>‚úÖ Financial Disaster (Recession)</li>
            <li>‚úÖ Financial Disaster (Collapse)</li>
            <li>‚úÖ Pandemic</li>
            <li>‚úÖ Civil Unrest</li>
            <li>üòï Asteroid</li>
          </ul>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/dondavis-BIGIMPCT.jpg">
          <div class="credit">credit:&nbsp;<a href="http://www.donaldedavis.com/PARTS/allyours.html" target="off">Don Davis</a></div>
        </div>
        <div class="box bottom">
          <h1>How's that Space Program?</h1>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fillh" src="images/nasa-Yj1M5riCKk4-unsplash.jpg">
          <div class="credit">credit:&nbsp;<a href="https://unsplash.com/@nasa" target="off">NASA</a></div>
        </div>
        <div class="box bottom">
          <h1>We need more than 6 people in space!</h1>
          <div class="mid">all aboard the ISS</div>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/automation.jpg"></div>
        <div class="box">
          <h1>I like automation</h1>
          <div class="mid"><a href="https://adameivy.com/presentation_automate_yourself">Automate Yourself Out of a Job</a></div>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/spreadsheet-1.jpg"></div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/spreadsheet-2.jpg"></div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/spreadsheet-3.jpg"></div>
      </section>
      <section class="gplay jellybean">
        <div class="fullscreen"><img class="fill" src="images/github.png"></div>
      </section>
      <section>
        <div class="fullscreen">
          <x-gif class="fill" src="images/dotfiles.gif" fill></x-gif>
        </div>
        <div class="box right">
          <h2>My dotfiles are Public</h2>
          <h2><a href="https://github.com/atomantic/dotfiles">github.com/atomantic/dotfiles</a></h2>
        </div>
      </section>
      <section class="gplay jellybean">
        <div class="fullscreen"><img class="fill" src="images/mlclass.png"></div>
        <div class="box black">
          <h1>3-hour ML Workshop</h1>
          <div class="mid"><span class="em-green">250+ participants</span></div>
          <h2><a href="https://github.com/atomantic/ml_class">github.com/atomantic/ml_class</a></h2>
        </div>
      </section>
      <section class="diagmonds black">
        <div class="box">
          <h1>Public Speaking</h1>
          <div class="mid"><span class="em-green notify" title="&lt;a href='https://adameivy.com/#/4', target='off'&gt;a few are available&lt;/a&gt;">40+ talks</span></div>
          <ul class="noprefix">
            <li><img src="images/gke.png" width="32px" /> Docker / Kubernetes</li>
            <li>üëì DevSecOps</li>
            <li><img src="images/nodejs.svg" width="32px" /> Node.js Performance &amp; Oddities</li>
            <li>üîì Security for Web Devs</li>
            <li><img src="images/lambda.jpeg" width="32px" /> Lambda/Serverless</li>
            <li><span class="notify" title="gitflow ‚û°Ô∏è release everything">ü§ñ Automation &amp; CI/CD</span></li>
            <li><img src="images/git.svg" width="32px" /> Developer Experience</li>
          </ul>
        </div>
      </section>
      <section>
        <div class="fullscreen">
          <div class="credit em-blue left">Story 1</div>
          <div class="credit"><a href="https://unsplash.com/@helloquence?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="off">credit: Helloquence</a></div>
        </div><img class="fillh" src="images/photo-1454165804606-c3d57bc86b40.jpeg">
        <div class="box">
          <h2>Open Source Software Approval Committee</h2>
          <div class="mid">member / contributor</div>
          <ul>
            <li>reviewed/approved OSS</li>
            <li>automation tooling for developers</li>
          </ul>
        </div>
      </section>
      <section>
        <div class="fullscreen">
          <div class="credit em-blue left">üòì Status Quo</div><img class="fillh" src="images/photo-1454506185424-4098f059c9e9.jpeg">
        </div>
        <div class="box">
          <h1>Hey, I want to use Node.js <span class="em-green">4.4.4</span></h1>
          <div class="mid">submit a ticket with a &nbsp;<span class="em-red">spreadsheet</span></div>
          <ul>
            <li>What's the License?</li>
            <li>Usage Questions</li>
            <li class="notify" title="no approval for SemVer ranges (&lt;, &lt;=, &gt;=, ~, ^, 1.x, 1.2.x, etc)" data-position="bottom left"><span class="em-orange">specific version</span></li>
          </ul>
        </div>
      </section>
      <section class="gplay jellybean">
        <div class="box">
          <pre><code class="language-bash notify" title="Standard Node.js Enforcer">‚áí  snoden&nbsp;&nbsp;&nbsp;
</code></pre>
          <pre class="notify" title="I wrote a tool (shared at 2016 Node Summit)" data-position="bottom center"><code class="language-yaml">Usage:  &lt;command&gt; [options]

Commands:
  check   ‚òëÔ∏è  check this project for standards, security and OSS
  update  üì¶  update this tool to the latest version

Options:
    --dev              üöß  include devDependencies in npm shrinkwrap
    --skip-clean       ‚è©  skip breaking on dirty git repo state
    --skip-gitignore   üôà  do not check for node_modules in .gitignore
    --skip-npm         ‚è©  skip npm install step (speeds up check if already done)
    --skip-nsp         ‚ò†  skip nsp (not recommended, enables offline test)
    --skip-shrinkwrap  ‚ö†Ô∏è  skip npm shrinkwrap (not recommended)
    --skip-update      üì¶  skip updating node packages (using updtr)
    --skip-xls         ‚è©  skip excel spreadsheet creation (useful on build server)
    -a, --auto         ‚õè  auto-fix issues without prompting or throwing errors
    -b, --build        ü§ñ  bot mode: skip corrective user prompts (throws errors)
</code></pre>
        </div>
      </section>
      <section class="gplay jellybean">
        <div class="box">
          <pre><code class="language-bash">‚áí  snoden check</code></pre>
          <pre class="notify" title="Generates OSS submission form with package info for Review Committee" data-position="bottom center"><code class="language-yaml notify" title="\[._.]/ - so easy">‚ùÑÔ∏è   \[._.]/ - Hi, I'm Snoden, the Standard Node.js Enforcer. Checking your package...
‚úÖ   git workspace is clean
‚úÖ   .nvmrc set to 4.4.7
‚ö°Ô∏è   npm install
‚úÖ   node_modules installed
‚úÖ   dependencies packages are pinned
‚úÖ   devDependencies packages are pinned
‚ö°Ô∏è   updating package deps with updtr
‚úÖ   packages up-to-date
‚úÖ   npm-shrinkwrap found
‚úÖ   .gitignore contains node_modules
‚ö°Ô∏è   nsp check
‚úÖ   (+) No known vulnerabilities found

  compiling xlsx [====================================] 100% 0.0s
</code></pre>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fillwb" src="images/drown.jpg">
          <div class="credit em-blue left">üòÑ Another Opportunity</div>
        </div>
        <div class="box">
          <h1>Drowning</h1>
          <h1 class="mid">the</h1>
          <h1>Committee</h1>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/ross.png"></div>
        <div class="box">
          <h2>...So, I wrote another tool</h2>
          <div class="mid"><span class="em-orange">RoSS</span> - Reviewer of Open Source Software</div>
        </div>
      </section>
      <section class="gplay jellybean">
        <div class="box">
          <h2><span class="em-blue">Snoden</span> &amp; <span class="em-green">RoSS</span> Together</h2>
          <ul>
            <li><span class="notify" title="Essentialism by Greg McKeown">Left committee to focus on other things</span></li>
            <li>Converted Intern to Full-Time</li>
            <li>Many improvements beyond my initial version</li>
            <li>Still running today</li>
          </ul>
        </div>
      </section>
      <section class="littleboxes blue">
        <div class="fullscreen">
          <div class="credit em-blue left">Story 2</div>
        </div>
        <div class="box">
          <h1>Kubernetes Microservices</h1>
          <div class="mid">Name: [redacted]</div>
          <ul>
            <li>Node.js APIs</li>
            <li><span class="notify" title="deployed everywhere">Vanilla JavaScript in Browsers</span></li>
            <li><a class="notify" href="http://containersummit.io/city-series/2016/seattle" target="off" title="Fireside Chat: 2016">Kubernetes (GKE)</a></li>
            <li>CI/CD DevSecOps (<span class="em-green">20x</span> daily deployments)</li>
            <li>Telemetry-Driven Development</li>
          </ul>
        </div>
      </section>
      <section class="littleboxes blue">
        <div class="fullscreen"></div>
        <div class="box">
          <h1>Full Service Ownership</h1>
          <div class="mid">My Responsibilities</div>
          <ul>
            <li>Legal / Compliance</li>
            <li>All Code / Architecture</li>
            <li>DevOps</li>
            <li>Tests (headless UI, API, synthetics, etc)</li>
            <li><span class="notify" title="2 calls / 2 years, automagically resolved by K8s">Production Support</span></li>
            <li>Security Modeling / Resolutions</li>
            <li>BI Dashboards (New Relic)</li>
          </ul>
        </div>
      </section>
      <section class="littleboxes blue">
        <div class="fullscreen"></div>
        <div class="box">
          <h1>Performance Tuning</h1>
          <div class="mid">Maximizing TPS</div><img class="fillw" src="images/nodeperf_jsonparser_vs_headers.png">
        </div>
      </section>
      <section class="littleboxes blue">
        <div class="fullscreen"></div>
        <div class="box">
          <h1>JSON is Complex</h1>
          <div class="mid">(more so than we need)</div>
          <ul>
            <li><span class="em-orange">Nested Objects</span></li>
            <li><span class="em-yellow">Arrays of Multiple Data Types</span></li>
            <li>parsing <span class="em-blue notify" title="7 characters!" data-position="right center">[{",:}]</span></li>
            <li>Number / String / Boolean / <span class="em-red">null</span></li>
          </ul>
        </div>
      </section>
      <section class="blue littleboxes">
        <div class="fullscreen"></div>
        <div class="box">
          <h2>üò∏ Embrace The Looseness of JavaScript</h2>
          <pre><code class="language-javascript">if(obj.foo === false || obj.foo === 0 || obj.foo === null || typeof obj.foo === "undefined") {
  // handle falsy case
}
// ok</code></pre>
          <h2>instead, test if <a href="https://developer.mozilla.org/en-US/docs/Glossary/Falsy">falsy</a></h2>
          <pre><code class="language-javascript">if(!obj.foo) { // if obj.foo is "falsy"
  // handle it
}
// ok</code></pre>
          <h2>‚ö° OR ‚ö°</h2>
          <pre><code class="language-javascript">return !!obj.foo // If you want a boolean: returns true if truthy, false if falsy
</code></pre>
        </div>
      </section>
      <section class="littleboxes blue">
        <div class="fullscreen"><img class="fill" src="images/spacex-TV2gg2kZD1o-unsplash.jpg">
          <div class="credit">credit:&nbsp;<a href="https://unsplash.com/@spacex?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="off">SpaceX</a></div>
        </div>
        <div class="box z150">
          <h2>What if we don't POST a body at all?</h2>
          <div class="mid">send the data as a header string...</div>
          <div class="mid">JSON.parse vs &nbsp;<span class="em-green">key`val``...</span>&nbsp; Header</div>
        </div>
      </section>
      <section class="littleboxes blue">
        <div class="fullscreen"></div>
        <div class="box z150">
          <div class="mid">Complexity Reduced</div>
          <div class="row">
            <div class="col">
              <h4>JSON</h4>
              <pre><code class="language-javascript">{
  "key": "val",
  "key2": "val2"
}</code></pre>
            </div>
            <div class="col">‚û°Ô∏è</div>
            <div class="col">
              <h4>Ticks</h4>
              <pre><code class="language-javascript">'key`val``key2`val2'</code></pre>
            </div>
          </div>
          <pre class="row"><code class="language-javascript">// a header called `_` with a value like 'key`val``key2`val2'
const params = Object.fromEntries(
  req.headers._.split('``')       // into pairs 'key`val'
    .map(pair=>pair.split('`'))   // [['key','val'],['key2','val2']]
) // now as js object: {key:'val', key2:'val2'}
</code></pre>
        </div>
      </section>
      <section class="littleboxes blue">
        <div class="fullscreen"></div>
        <div class="box z200">
          <h2>Success!</h2>
          <h4><span class="em-red">26.8ms</span> ‚û°Ô∏è <span class="em-green">1.11ms</span></h4>
          <div class="mid">with caveat</div>
          <h4>üò≤ Documentation / Hand-off</h4>
        </div>
      </section>
      <section class="escheresque midnight">
        <div class="fullscreen">
          <div class="credit em-blue left">Story 3</div>
        </div>
        <div class="box">
          <h1>S3 Auth Lambda</h1>
          <div class="mid">Challenges with Shared Solution</div>
          <ul>
            <li><span class="em-red">Java</span> developers wrote <span class="em-green">Node.js</span> code</li>
            <li>Large codebase</li>
            <li><span class="em-red">1 MB</span> limit for CloudFront Lambda@Edge</li>
            <li>Solution Required IdP Client Secret</li>
            <li><span class="em-red">No Secrets</span> in Lambda@Edge!</li>
            <li><span class="notify" title="(every CSS/image/3rd party lib file)">Excessive Lambda Hits</span></li>
          </ul>
        </div>
      </section>
      <section class="white">
        <div class="fullscreen"><img class="fillh" src="images/IdPLambda-flow-1.png"></div>
        <div class="box top right">
          <h4>Original HLA</h4>
        </div>
      </section>
      <section class="escheresque midnight">
        <div class="box left notify" title="some red flags">
          <pre><code class="language-javascript">var unprotectedUris = [
  RegExp("/public/.*"), 
  RegExp("/favicon.ico"), 
  RegExp("/css/.*"), 
  RegExp("/js/.*"), 
  RegExp(".*touch-icon.*")
];

function isUnprotected(uri) {
    for (var x = 0; x < unprotectedUris.length; x++) {
        var pattern = unprotectedUris[x];
        if (pattern.test(uri))
            return true;
    }
    return false;
}
if (isUnprotected(request.uri)) {
    console.log("Allowing access to unprotected resource:" + request.uri);
    callback(null, request);
    return;
}
</code></pre>
        </div>
      </section>
      <section class="escheresque midnight">
        <div class="fullscreen">
          <div class="credit em-blue left">üîé Project 2</div>
        </div>
        <div class="box">
          <h2>Steps</h2>
          <ol>
            <li>CloudFront Behaviors for Public assets</li>
            <li>Remove IdP Callback</li>
            <li>Major Code Refactor</li>
          </ol>
        </div>
      </section>
      <section class="white">
        <div class="fullscreen">
          <div class="box white">
            <div class="row">
              <div class="col"><img class="fill" src="images/IdPLambda-flow-1.png"></div>
              <div class="col" style="vertical-align:middle;height:100%;margin:auto;text-shadow:none">‚û°Ô∏è</div>
              <div class="col"><img class="fill" src="images/IdPLambda-flow-2.png"></div>
            </div>
          </div>
        </div>
      </section>
      <section class="escheresque midnight">
        <div class="box left notify" title="‚ùé no hash eval loops&lt;br/&gt;‚úÖ RegExp&lt;br/&gt;‚ùé no setCookie Function&lt;br/&gt;‚úÖ use max-age&lt;br/&gt;‚úÖ Redirect (from 401 handler)" data-position="right middle">
          <div class="mid">jwt.html (in S3, not Lambda)</div>
          <pre><code class="language-javascript line-numbers">&lt;html&gt;&lt;head&gt;&lt;script type="text/javascript"&gt;
  var h = window.location.hash
  // capture value until '&' or end of line invalidates capture
  var tokenMatch = h.match(/access_token=([^&]+)/)
  var expiresMatch = h.match(/expires_in=([^&]+)/)
  if(tokenMatch && expiresMatch){
    document.cookie = 'jwt='+tokenMatch[1]+';max-age='+expiresMatch[1]
  }
  var target = sessionStorage.redirectUri||'/'
  sessionStorage.clear()
  window.location = target
&lt;/script&gt;&lt;/head&gt;&lt;/html&gt;
</code></pre>
        </div>
      </section>
      <section class="escheresque midnight">
        <div class="box">
          <h1>Refactoring S3 Auth Lambda</h1>
          <div class="mid">Guiding Ideas</div>
          <ul class="noprefix">
            <li>‚ö° Functional Programming</li>
            <li>‚Ü©Ô∏è Return ASAP</li>
            <li>üì¶ Modularize Heavily</li>
            <li>üíª Use (understandable) Regular Expressions</li>
            <li>‚ùå Delete Code <span class="em-red">original &gt;800 SLOC</span></li>
          </ul>
        </div>
      </section>
      <section class="escheresque midnight">
        <div class="box left notify" title="üëé jwtUtil.js&lt;br/&gt;‚úÖ modular&lt;br/&gt;üëé Try/Catch" data-position="right middle">
          <h2>First Stab</h2>
          <div class="mid">lambda/auth.js</div>
          <pre class="line-numbers" data-line="11"><code class="language-javascript">const getJwt = require('./lib/getJwt')
const JwtUtil = require('./lib/jwtUtil') // legacy, TODO: refactor
const jwt = new JwtUtil(require('./data/jwks'))
const response401 = require('./lib/response401')

exports.handler = (event, context, callback) => {
  const request = event.Records[0].cf.request
  const token = getJwt(request)
  if (!token) return callback(null, response401('bad token'))
  try {
    const tokenData = jwt.verify(token)
    console.log("JWT validated", JSON.stringify(tokenData, null, 2))
    request.headers['access-control-allow-origin'] = [ 
        { key: 'Access-Control-Allow-Origin', value: '*' } 
    ]
    return callback(null, request) // pass request through to S3
  } catch (err) {
    callback(null, response401(err))
  }
}</code></pre>
        </div>
      </section>
      <section class="escheresque midnight">
        <div class="box">
          <div class="mid">lambda/lib/response401.js</div>
          <pre><code class="language-javascript">module.exports = function response401(text) {
    return {
        body: `&lt;script type="text/javascript"&gt;
        sessionStorage.redirectUri = window.location.href;
        window.location.href='https://REDACTED_IDP_URL';
        &lt;/script&gt;`,
        bodyEncoding: 'text',
        status: '401',
        statusDescription: 'Authentication Required (' + text + ')'
    }
}
</code></pre>
        </div>
      </section>
      <section class="escheresque midnight">
        <div class="multibox">
          <div class="title mid">lambda/lib/getJwt.js (with RegExp)</div>
          <div class="box left">
            <h4 class="title">Original</h4>
            <pre><code class="language-javascript">module.exports = function getJwt(request) {
  let cookie = request.headers.cookie
  if(typeof cookie === "undefined") return null
  for (let x=0; x&lt;cookie.length; x++) {
    let cookieVal = cookie[x].value
    if (cookieVal) {
      let cookies = cookieVal.split(";")
      for (let y=0; y&gt;cookies.length; y++) {
        let pair = cookies[y].trim().split("=")
        if (pair[0] === "jwt") {
            return pair[1]
        }
      }
    }
  }
  return null
}</code></pre>
          </div>
          <div class="box right">
            <h4 class="title">Simplified</h4>
            <pre><code class="language-javascript">/*
Lambda at the Edge headers are array objects.
request.headers.cookie = [{
  key: 'cookie',
  value: '...; jwt=...; ...'
}]
...our auth service sets one cookie header
*/
module.exports = function getJwt(request) {
  const h = request.headers.cookie
  if (!h || !h.length) return null
  
  const cookies = h[0].value.replace(/\s/g,'')
  const matches = cookies.match(/jwt=([^;]+)/)
  return matches ? matches[1] : null
}
</code></pre>
          </div>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/jwtUtil.png"></div>
      </section>
      <section class="escheresque midnight">
        <div class="box z150">
          <h2>OOP is <span class="em-red animated zoomIn">Overkill</span></h2>
          <div class="mid">ok for monoliths, bad for tiny micro modules</div>
          <h2>Use Modular Functions</h2>
        </div>
      </section>
      <section class="escheresque midnight">
        <div class="box notify" title="ü§î" data-position="right middle">
          <div class="mid">./lib/jwtUtil.js ‚û°Ô∏è ./lib/verify.js</div>
          <pre class="line-numbers" data-line="5-10"><code class="language-javascript">const base64url = require('base64url')
const jwkToPem = require('jwk-to-pem')
const jwt = require('jsonwebtoken')
const keys = {} // kid indexed keys
require('../data/jwks').keys.forEach((jwk)=>{
    keys[jwk.kid] = {
        jwk: jwk,
        pem: jwkToPem(jwk)
    }
})
module.exports = (token) => {
    try {
        const head = JSON.parse(
            base64url.decode(token.split('.',1)[0])
        )
        const key = keys[head.kid]
        return jwt.verify(token, key.pem)
    } catch(err) {
        throw err
    }
}
</code></pre>
        </div>
      </section>
      <section class="escheresque midnight">
        <div class="multibox">
          <h2 class="title">Why Parse PEMs Every Hit?</h2>
          <div class="title mid">Generate them once!</div>
          <div class="box left">
            <div class="mid">./lib/makekeys.js (temp)</div>
            <pre><code class="language-javascript">const jwks = require('../data/jwks').keys
const jwkToPem = require('jwk-to-pem')
const fs = require('fs')

const keys = {}

jwks.forEach((jwk)=>{
    keys[jwk.kid] = jwkToPem(jwk)
})

fs.writeFileSync(
    `${__dirname}/../data/keys.json`, 
    JSON.stringify(keys, null, 2)
)</code></pre>
          </div>
          <div class="box right">
            <pre><code class="language-bash">node ./lib/makekeys.js</code></pre>
            <div class="mid">./data/keys.json</div>
            <pre><code class="language-javascript">{
  "rsa03": "-----BEGIN PUBLIC KEY-----\n...",
  "rsa02": "-----BEGIN PUBLIC KEY-----\n..."
}
</code></pre>
          </div>
        </div>
      </section>
      <section class="escheresque midnight">
        <div class="box notify" title="ü§î keep reducing... do we need multiple keys?" data-position="bottom center">
          <div class="mid">./lib/verify.js</div>
          <pre class="line-numbers"><code class="language-javascript">const base64url = require('base64url')
const jwt = require('jsonwebtoken')
const keys = require('../data/keys')

module.exports = (token)=>{
    try {
        const head = JSON.parse(
            base64url.decode(token.split('.',1)[0])
        )
        return jwt.verify(token, keys[head.kid])
    } catch(err) {
        throw err
    }
}</code></pre>
        </div>
      </section>
      <section class="escheresque midnight">
        <div class="box left notify" title="‚úÖ Fewer Modules&lt;br/&gt;‚úÖ No JSON.parse&lt;br/&gt;‚úÖ No Try/Catch&lt;br/&gt;" data-position="right middle">
          <div class="mid">./auth.js (Lambda@Edge Function)</div>
          <pre class="line-numbers"><code class="language-javascript">const getJwt = require('./lib/getJwt')
const jwt = require('jsonwebtoken')
const pem = '-----BEGIN PUBLIC KEY--REDACTED\n'
const response401 = require('./lib/response401')

exports.handler = (event, context, callback) => {
    const request = event.Records[0].cf.request
    var token = getJwt(request)
    if (!token) return callback(null, response401)
    // use JWT library to validate token against IdP public key
    jwt.verify(token, pem, function(err, decoded) {
        if(err) return callback(null, response401)
        // cors support (required for S3 passthrough to CloudFront)
        request.headers['access-control-allow-origin'] = [ 
            { key: 'Access-Control-Allow-Origin', value: '*' } 
        ]
        // allow request to proxy to S3
        return callback(null, request)
    })
}
</code></pre>
        </div>
      </section>
      <section class="escheresque midnight">
        <div class="multibox">
          <div class="box left top">
            <h3><span class="em-red">&gt; 800 SLOC</span></h3>
            <div class="mid">into</div>
            <h3><span class="em-green">34 SLOC!</span></h3>
          </div>
          <div class="box left bottom smaller">
            <div class="mid">./auth.js</div>
            <pre class="line-numbers"><code class="language-javascript">const getJwt = require('./lib/getJwt')
const jwt = require('jsonwebtoken')
const pem = '-----BEGIN PUBLIC KEY--REDACTED\n'
const response401 = require('./lib/response401')
exports.handler = (event, context, callback) => {
  const request = event.Records[0].cf.request
  var token = getJwt(request)
  if (!token) return callback(null, response401)
  jwt.verify(token, pem, function(err, decoded) {
    if(err) return callback(null, response401)
    request.headers['access-control-allow-origin'] = [ 
      { key: 'Access-Control-Allow-Origin', value: '*' } 
    ]
    return callback(null, request)
  })
}</code></pre>
          </div>
          <div class="box right top smaller">
            <div class="mid">./lib/getJwt.js</div>
            <pre class="line-numbers"><code class="language-javascript">module.exports = function getJwt(request) {
  const header = request.headers.cookie
  if (!header || !header.length) {
    return null // no cookies
  }
  const cookies = header[0].value.replace(/\s/g,'')
  const matches = cookies.match(/jwt=([^;]+)/)
  return matches ? matches[1] : null
}</code></pre>
          </div>
          <div class="box right bottom smaller">
            <div class="mid">./lib/response401.js</div>
            <pre class="line-numbers"><code class="language-javascript">module.exports = {
  body: `&lt;script type="text/javascript"&gt;
  sessionStorage.redirectUri = window.location.href;
  window.location.href='https://REDACTED_IDP_URL';
  &lt;/script&gt;`,
  bodyEncoding: 'text',
  status: '401',
  statusDescription: 'Authentication Required'
}</code></pre>
          </div>
        </div>
      </section>
      <section class="escheresque midnight">
        <div class="multibox">
          <div class="box left top">
            <h3><span class="em-green">34 SLOC</span></h3>
            <div class="mid">into</div>
            <h3><span class="em-red">28 SLOC...</span></h3>
          </div>
          <div class="box bottom left">
            <ul class="noprefix">
              <li>üòü harder to unit test</li>
              <li>üò© harder to read</li>
            </ul>
          </div>
          <div class="box top right smaller">
            <div class="mid">./auth.js</div>
            <pre class="line-numbers"><code class="language-javascript">const jwt = require('jsonwebtoken')
const pem = '-----BEGIN PUBLIC KEY--REDACTED\n'
const response401 = {
  body: `&lt;script type="text/javascript"&gt;
  sessionStorage.redirectUri = window.location.href;
  window.location.href='https://REDACTED_IDP_URL';
  &lt;/script&gt;`,
  bodyEncoding: 'text',
  status: '401',
  statusDescription: 'Authentication Required'
}
exports.handler = (event, context, callback) => {
  const request = event.Records[0].cf.request
  const header = request.headers.cookie
  if (!header || !header.length) 
    return callback(null, response401)
  const cookies = header[0].value.replace(/\s/g,'')
  const matches = cookies.match(/jwt=([^;]+)/)
  const token = matches ? matches[1] : null
  if (!token) return callback(null, response401)
  jwt.verify(token, pem, function(err, decoded) {
    if(err) return callback(null, response401)
    request.headers['access-control-allow-origin'] = [ 
      { key: 'Access-Control-Allow-Origin', value: '*' } 
    ]
    return callback(null, request)
  })
}
</code></pre>
          </div>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/nasa-NuE8Nu3otjo-unsplash.jpg">
          <div class="credit">credit:&nbsp;<a href="https://unsplash.com/@nasa?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="off">NASA</a></div>
        </div>
        <div class="box bottom">
          <h1>Why Blue Origin?</h1>
          <div class="mid"><span class="reg">üßí</span>&nbsp; Because of my daughter</div>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/dondavis-Spacecolony1.jpg">
          <div class="credit em-blue left">ü§∑ Why Blue Origin?</div>
          <div class="credit">credit:&nbsp;<a href="http://www.donaldedavis.com/PARTS/allyours.html" target="off">Don Davis</a></div>
        </div>
        <div class="box">
          <h1>You Had Me</h1>
          <div class="mid">at</div>
          <h1>O'Neill Cylinders</h1>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fillh left" src="images/dondavis-DDcylECL.jpg">
          <div class="credit">credit:&nbsp;<a href="http://www.donaldedavis.com/PARTS/allyours.html" target="off">Don Davis</a></div>
        </div>
        <div class="box right">
          <ul>
            <li>Arbitrary Gravity</li>
            <li><span class="notify" title="üö´ earthquakes&lt;br /&gt;üö´ volcanoes&lt;br /&gt;üö´ hurricanes">Arbitrary Weather</span></li>
            <li>Sustainability</li>
            <li>Collision Avoidance</li>
            <li><span class="notify" title="microservices" data-position="bottom center"> Let's maybe make more of them, smaller</span></li>
          </ul>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/nasa-OLlj17tUZnU-unsplash.jpg">
          <div class="credit em-blue left">ü§∑ Why Blue Origin?</div>
          <div class="credit">credit:&nbsp;<a href="https://unsplash.com/@nasa?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="off">NASA</a></div>
        </div>
        <div class="box left top">
          <h1>Obvious next step</h1>
        </div>
      </section>
      <section class="littleboxes blue">
        <div class="fullscreen"><img class="fill" src="images/spacex--p-KCm6xB9I-unsplash.jpg">
          <div class="credit em-blue left">ü§∑ Why Blue Origin?</div>
          <div class="credit">credit:&nbsp;<a href="https://unsplash.com/@spacex?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="off">SpaceX</a></div>
        </div>
        <div class="box z150">
          <h2><a href="https://www.antipope.org/charlie/blog-static/fiction/accelerando/accelerando-intro.html" target="off">Accelerando</a></h2>
          <div class="mid">Charles Stross</div>
        </div>
      </section>
      <section class="littleboxes blue">
        <div class="fullscreen"><img class="fill" src="images/lux-interaction-UDETRRE5Mzc-unsplash.jpg">
          <div class="credit em-blue left">ü§∑ Why Blue Origin?</div>
          <div class="credit">credit:&nbsp;<a href="https://unsplash.com/@luxinteraction?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="off">Lux Interaction</a></div>
        </div>
        <div class="box top right">
          <h2>Virtual Reality</h2>
          <div class="mid">racing against progress</div>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/vincentiu-solomon-ln5drpv_ImI-unsplash.jpg">
          <div class="credit em-blue left">ü§∑ Why Blue Origin?</div>
          <div class="credit">credit:&nbsp;<a href="https://unsplash.com/@jeremythomasphoto?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="off">Jeremy Thomas</a></div>
        </div>
        <div class="box z150">
          <div class="mid">Because I Like</div>
          <h2>üõ∏ Star Trek &gt; üí• Star Wars</h2>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/jeremy-thomas-E0AHdsENmDg-unsplash.jpg">
          <div class="credit em-blue left">ü§∑ Why Blue Origin?</div>
          <div class="credit">credit:&nbsp;<a href="https://unsplash.com/@jeremythomasphoto?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="off">Jeremy Thomas</a></div>
        </div>
        <div class="box">
          <h1>My Greatest Value</h1>
          <div class="mid">üöÄ I want to be a force multiplier here</div>
          <ul class="noprefix">
            <li>üòê <strike>Mars</strike></li>
            <li>üòé Space</li>
          </ul>
        </div>
      </section>
      <section>
        <div class="fullscreen"><img class="fill" src="images/nasa-Q1p7bh3SHj8-unsplash.jpg">
          <div class="credit">credit:&nbsp;<a href="https://unsplash.com/@nasa?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="off">NASA</a></div>
        </div>
        <div class="multibox">
          <div class="box left top z120">
            <h1 class="mid">Thanks!</h1>
            <h2>ü§î Q&amp;A?</h2>
            <div class="line">
              <div class="me center"></div>
            </div>
            <h2><span class="notranslate emoticon rocking">\[._.]/</span><span class="notranslate">&nbsp; <a href="https://adameivy.com" target="off">Adam Eivy</a></span></h2>
            <blockquote>
              <h3><a href="https://bit.ly/adam_blue"><i class="fa fa-desktop"></i>&nbsp;bit.ly/adam_blue</a></h3>
              <h3><a href="https://twitter.com/antic"><i class="fa fa-twitter-square"></i>&nbsp;@antic</a></h3>
              <h3><a href="https://github.com/atomantic"><i class="fa fa-github-square"></i>&nbsp;/atomantic</a></h3>
            </blockquote><small><a class="back" href="#1">&nbsp; restart</a></small>
          </div>
        </div>
        <div class="box top right"></div>
      </section>
    </article>
    <script src="build/build.js"></script>
  </body>
</html>